<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JUAN AI - Deep Ocean</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Raleway:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent-cyan: #00f2ff;
            --deep-indigo: #010a16;
            --text-main: #e0f7fa;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --input-bg: #0a192f;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; padding: 0; 
            -webkit-tap-highlight-color: transparent; 
        }

        html, body {
            height: 100%; width: 100%;
            overflow: hidden; 
            background: var(--deep-indigo);
            color: var(--text-main);
            font-family: 'Raleway', sans-serif;
        }

        /* Animated Ocean Background */
        .ocean-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: linear-gradient(180deg, #010a16 0%, #001c3a 35%, #003855 50%, #001c3a 65%, #010a16 100%);
            background-size: 100% 400%;
            animation: oceanFlow 30s ease-in-out infinite;
        }

        @keyframes oceanFlow {
            0% { background-position: 50% 0%; }
            50% { background-position: 50% 100%; }
            100% { background-position: 50% 0%; }
        }

        /* --- –≠–ö–†–ê–ù –ü–ï–†–ï–•–û–î–ê --- */
        #screen-intro {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2000; background: var(--deep-indigo);
            display: none;
            flex-direction: column; align-items: center; justify-content: center;
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        .intro-video { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            object-fit: cover; 
            filter: brightness(0.6); 
        }

        .container {
            width: 100%; max-width: 500px; height: 100dvh;
            margin: 0 auto; display: flex; flex-direction: column;
            position: relative; overflow: hidden;
        }

        .screen { display: none; flex: 1; flex-direction: column; overflow-y: auto; padding: 20px; animation: fadeIn 0.4s ease; }
        .active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .flow-content { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100%; gap: 20px; text-align: center; }

        /* --- –°–¢–ò–õ–ò –ê–í–ê–¢–ê–†–ê --- */
        .avatar-main {
            width: 120px; 
            height: 120px; 
            border-radius: 50%; 
            padding: 3px; 
            background: linear-gradient(135deg, var(--accent-cyan), transparent);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.2);
            margin-bottom: 10px;
            display: flex; 
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1; 
        }

        .avatar-main img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            border-radius: 50%; 
            display: block;
        }

        input, select, textarea {
            width: 100%; background: var(--input-bg); border: 1px solid rgba(255,255,255,0.2);
            padding: 14px; color: #fff; font-family: inherit; font-size: 16px; border-radius: 15px; outline: none; text-align: center;
        }
        select option { background-color: var(--input-bg); color: #fff; }

        button.minimal-btn {
            background: var(--glass-bg); border: 1px solid var(--accent-cyan);
            color: #fff; padding: 16px 30px; border-radius: 50px;
            font-size: 14px; letter-spacing: 2px; cursor: pointer; transition: 0.3s;
            text-transform: uppercase; width: 100%; font-weight: 600;
        }
        button.minimal-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .form-toggle-link { font-size: 11px; opacity: 0.5; text-decoration: underline; cursor: pointer; margin-top: 10px; letter-spacing: 1px; }

        .create-container { display: none; width: 100%; flex-direction: column; gap: 12px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }

        .chat-stage { position: relative; flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; overflow: hidden; }
        .model-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .model-img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.8); }
        .chat-stage::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 40%; background: linear-gradient(to top, var(--deep-indigo) 10%, transparent 100%); z-index: 2; }

        .ai-bubble-container { z-index: 10; width: 85%; margin-bottom: 110px; transform-origin: bottom center; display: none; }
        
        .ai-bubble { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            color: #fff; 
            padding: 15px 20px; 
            border-radius: 20px; 
            font-size: 14px; 
            line-height: 1.5; 
            position: relative; 
            border: 1px solid rgba(255,255,255,0.1); 
            text-align: center; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-height: 55vh; 
            overflow-y: auto; 
            word-wrap: break-word;
            overflow-x: hidden;
        }

        .user-temp-msg { position: absolute; bottom: 100px; z-index: 15; background: var(--accent-cyan); color: #010a16; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; box-shadow: 0 5px 15px rgba(0, 242, 255, 0.3); transition: 0.6s ease; }
        .fade-out { opacity: 0; transform: translateY(-20px); }

        .chat-controls { z-index: 20; padding: 15px 20px 30px; background: var(--deep-indigo); width: 100%; }
        .input-row { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.08); padding: 8px 15px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); }
        #chat-input { text-align: left; border: none; padding: 8px; flex: 1; background: transparent; color: #fff; }
        .send-btn { width: 40px; height: 40px; background: var(--accent-cyan); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #010a16; cursor: pointer; border: none; font-size: 20px; }
        #typing-indicator { position: absolute; top: -20px; width: 100%; text-align: center; font-size: 10px; color: var(--accent-cyan); letter-spacing: 2px; opacity: 0; transition: 0.3s; }
        .header-chat { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 30; border-bottom: 1px solid rgba(255,255,255,0.05); background: rgba(1, 10, 22, 0.9); }

        /* Mute Button Styles */
        .mute-toggle {
            font-size: 20px; color: var(--text-main); cursor: pointer;
            margin-right: 15px; opacity: 0.8;
        }

        /* Error Banner */
        #error-banner {
            position: fixed; top: 0; left: 0; width: 100%;
            background: rgba(255, 0, 80, 0.9); color: white;
            padding: 20px; z-index: 3000; text-align: center;
            display: none; font-size: 14px;
        }
    </style>
</head>
<body>

    <div id="error-banner">
        <strong>–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ!</strong><br>
        –ó–∞–π–¥–∏ –≤ Firebase Console -> Firestore -> Rules<br>
        –ò —Ä–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø (publish rules).<br>
        <button onclick="this.parentElement.style.display='none'" style="margin-top:10px; padding:5px 10px; background:white; color:black; border:none; border-radius:5px;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <!-- –≠–ö–†–ê–ù –ü–ï–†–ï–•–û–î–ê -->
    <div id="screen-intro">
        <video class="intro-video" id="main-intro-video" playsinline>
            <source src="https://image2url.com/r2/default/videos/1771105346041-b5551378-9d6e-4b75-89b8-727d83f6f4cb.mp4" type="video/mp4">
        </video>
    </div>

    <div class="ocean-bg"></div>

    <div class="container">
        <!-- AUTH -->
        <div id="screen-auth" class="screen active">
            <div class="flow-content">
                <div class="avatar-main">
                    <img src="https://r2.syntx.ai/user_5069746049/generated/8fa9666f4e7dcac53988afe15aac6a1a_midjourney_image_2_1759615922.png">
                </div>
                
                <div id="auth-main-ui" style="width: 100%; display: flex; flex-direction: column; gap: 12px;">
                    <div style="font-size: 10px; letter-spacing: 3px; opacity: 0.6; text-transform: uppercase;">–¢–≤–æ–π —Å–∏–≥–Ω–∞–ª</div>
                    <select id="user-select"><option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>
                    <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
                    <button class="minimal-btn" id="login-btn" onclick="login()">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    <span class="form-toggle-link" onclick="toggleForm('auth-create-ui', 'auth-main-ui')">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª</span>
                </div>

                <div id="auth-create-ui" class="create-container">
                    <div style="font-size: 10px; letter-spacing: 3px; opacity: 0.6; text-transform: uppercase;">–ù–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª</div>
                    <input type="text" id="new-user-id" placeholder="–ò–º—è">
                    <input type="password" id="new-user-pass" placeholder="–ü–∞—Ä–æ–ª—å">
                    <button class="minimal-btn" id="create-btn" onclick="handleCreateUser()">–°–æ–∑–¥–∞—Ç—å</button>
                    <span class="form-toggle-link" onclick="toggleForm('auth-main-ui', 'auth-create-ui')">–ù–∞–∑–∞–¥</span>
                </div>
            </div>
        </div>

        <!-- HERO -->
        <div id="screen-hero" class="screen">
            <div class="flow-content">
                <div id="hero-main-ui" style="width: 100%; display: flex; flex-direction: column; gap: 12px;">
                    <div style="font-size: 10px; letter-spacing: 3px; opacity: 0.6; text-transform: uppercase;">–í—ã–±–µ—Ä–∏ —Å–æ–∑–Ω–∞–Ω–∏–µ</div>
                    <select id="partner-select"></select>
                    <button class="minimal-btn" onclick="startChat()">–í–æ–π—Ç–∏ –≤ —Ä–µ–∑–æ–Ω–∞–Ω—Å</button>
                    <span class="form-toggle-link" onclick="toggleForm('hero-create-ui', 'hero-main-ui')">–ü—Ä–∏–∑–≤–∞—Ç—å –Ω–æ–≤–æ–µ —Å–æ–∑–Ω–∞–Ω–∏–µ</span>
                    <p onclick="showScreen('screen-auth')" style="cursor:pointer; opacity: 0.5; margin-top: 20px; font-size: 10px; letter-spacing: 2px;">–í–´–ô–¢–ò</p>
                </div>

                <div id="hero-create-ui" class="create-container">
                    <div style="font-size: 10px; letter-spacing: 3px; opacity: 0.6; text-transform: uppercase;">–ù–æ–≤–æ–µ —Å–æ–∑–Ω–∞–Ω–∏–µ</div>
                    <input type="text" id="new-p-name" placeholder="–ò–º—è">
                    <textarea id="new-p-prompt" placeholder="–ù–∞—Å—Ç—Ä–æ–π/–•–∞—Ä–∞–∫—Ç–µ—Ä..." style="height: 80px;"></textarea>
                    <button class="minimal-btn" id="create-p-btn" onclick="handleCreatePartner()">–ü—Ä–∏–∑–≤–∞—Ç—å</button>
                    <span class="form-toggle-link" onclick="toggleForm('hero-main-ui', 'hero-create-ui')">–ù–∞–∑–∞–¥</span>
                </div>
            </div>
        </div>

        <!-- CHAT -->
        <div id="screen-chat" class="screen" style="padding: 0;">
            <div class="header-chat">
                <div style="font-size: 13px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase;" id="partner-name-display">JUAN</div>
                <div style="display: flex; align-items: center;">
                    <span id="sound-toggle" class="mute-toggle" onclick="toggleSound()">üîä</span>
                    <div onclick="showScreen('screen-hero')" style="font-size: 10px; opacity: 0.6; cursor: pointer; letter-spacing: 1px;">–ù–ê–ó–ê–î</div>
                </div>
            </div>

            <div class="chat-stage">
                <div class="model-container">
                    <img id="partner-model-img" class="model-img" src="">
                </div>
                <div id="ai-bubble-container" class="ai-bubble-container">
                    <div id="ai-text" class="ai-bubble">–Ø —Å–ª—É—à–∞—é... üåä</div>
                </div>
                <div id="user-temp-container"></div>
            </div>

            <div class="chat-controls">
                <div id="typing-indicator">–ü–†–ò–ï–ú –°–ò–ì–ù–ê–õ–ê...</div>
                <div class="input-row">
                    <input type="text" id="chat-input" placeholder="–®–µ–ø–Ω–∏..." autocomplete="off">
                    <button class="send-btn" onclick="send()">‚ú¶</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        //  –¢–í–û–ò –ö–õ–Æ–ß–ò
        // ==========================================
        
        const manualConfig = {
            apiKey: "AIzaSyABu6X791u9Ph7R5-UYgiZ-3a_5XNidycw",
            authDomain: "juan-ai-app.firebaseapp.com",
            projectId: "juan-ai-app",
            storageBucket: "juan-ai-app.firebasestorage.app",
            messagingSenderId: "70161662358",
            appId: "1:70161662358:web:8b8da057e22189ff065db7"
        };

        const geminiApiKey = "AIzaSyDNCX-WFxbCS41EakUliMQ4qb-jS584b1A"; 

        // === ELEVENLABS SETTINGS ===
        const elevenApiKey = "sk_40577705e00be2878dc47321a99a0a949151d526bbf9ab30"; 
        const voiceId = "6A9D8WSMm4rFsg2DWFeE"; 
        // ===========================
        
        let firebaseConfig = manualConfig;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const appId = firebaseConfig.projectId;

        let state = { user: null, currentUserData: null, currentPartner: null, partners: [], users: [] };
        let isSoundOn = true;

        const init = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.warn("Auth check:", error);
            }
        };

        onAuthStateChanged(auth, (fbUser) => {
            state.user = fbUser;
            if (fbUser) setupDataListeners();
        });

        init();

        function setupDataListeners() {
            if (!state.user) return;
            const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
            const partnersRef = collection(db, 'artifacts', appId, 'public', 'data', 'partners');

            onSnapshot(usersRef, (snap) => {
                state.users = snap.docs.map(d => ({id: d.id, ...d.data()}));
                updateLists();
            }, (error) => {
                if(error.code === 'permission-denied') document.getElementById('error-banner').style.display = 'block';
            });

            onSnapshot(partnersRef, (snap) => {
                state.partners = snap.docs.map(d => ({id: d.id, ...d.data()}));
                updateLists();
            }, (error) => {
                if(error.code === 'permission-denied') document.getElementById('error-banner').style.display = 'block';
            });
        }

        function updateLists() {
            const uSelect = document.getElementById('user-select');
            const pSelect = document.getElementById('partner-select');
            if (uSelect) uSelect.innerHTML = state.users.map(u => `<option value="${u.id}">${u.id.toUpperCase()}</option>`).join('') || '<option value="">–°–û–ó–î–ê–ô –ù–û–í–´–ô –°–ò–ì–ù–ê–õ</option>';
            if (pSelect) pSelect.innerHTML = state.partners.map(p => `<option value="${p.id}">${p.name.toUpperCase()}</option>`).join('') || '<option value="">–ü–†–ò–ó–û–í–ò –°–û–ó–ù–ê–ù–ò–ï</option>';
        }

        window.toggleForm = (showId, hideId) => {
            document.getElementById(showId).style.display = 'flex';
            document.getElementById(hideId).style.display = 'none';
        };

        window.showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        window.toggleSound = () => {
            isSoundOn = !isSoundOn;
            document.getElementById('sound-toggle').innerText = isSoundOn ? 'üîä' : 'üîá';
            if(!isSoundOn) {
                window.speechSynthesis.cancel();
            }
        };

        window.handleCreateUser = async () => {
            console.log("–ö–Ω–æ–ø–∫–∞ '–°–æ–∑–¥–∞—Ç—å' –Ω–∞–∂–∞—Ç–∞");
            const btn = document.getElementById('create-btn');
            
            if (!state.user) {
                return alert("–°–∏—Å—Ç–µ–º–∞ –µ—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª–∞—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü–æ–¥–æ–∂–¥–∏ 3 —Å–µ–∫—É–Ω–¥—ã –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.");
            }
            
            const id = document.getElementById('new-user-id').value.trim().toLowerCase();
            const pass = document.getElementById('new-user-pass').value.trim();
            
            if (!id || !pass) return alert('–ò–º—è –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!');
            
            try {
                btn.innerText = "–°–æ–∑–¥–∞–Ω–∏–µ...";
                btn.disabled = true;
                
                // –ó–∞–ø–∏—Å—å –≤ –±–∞–∑—É
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), { pass });
                
                alert("–°–∏–≥–Ω–∞–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏ –µ–≥–æ –≤ —Å–ø–∏—Å–∫–µ –∏ –≤–æ–π–¥–∏.");
                
                // –û—á–∏—Å—Ç–∫–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç
                document.getElementById('new-user-id').value = '';
                document.getElementById('new-user-pass').value = '';
                btn.innerText = "–°–æ–∑–¥–∞—Ç—å";
                btn.disabled = false;
                
                toggleForm('auth-main-ui', 'auth-create-ui');
                
            } catch (e) { 
                console.error("–û–®–ò–ë–ö–ê –°–û–ó–î–ê–ù–ò–Ø:", e);
                alert("–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É: " + e.message + "\n–ö–æ–¥: " + e.code);
                btn.innerText = "–°–æ–∑–¥–∞—Ç—å";
                btn.disabled = false;
            }
        };

        window.handleCreatePartner = async () => {
             const btn = document.getElementById('create-p-btn');
             if (!state.user) return alert("–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
             
            const name = document.getElementById('new-p-name').value.trim();
            const img = 'https://r2.syntx.ai/user_5069746049/generated/8fa9666f4e7dcac53988afe15aac6a1a_midjourney_image_2_1759615922.png';
            const prompt = document.getElementById('new-p-prompt').value.trim();
            
            if (!name) return alert('–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
            
            try {
                btn.innerText = "–ü—Ä–∏–∑—ã–≤...";
                btn.disabled = true;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'partners'), { name, img, prompt });
                
                alert("–°–æ–∑–Ω–∞–Ω–∏–µ –ø—Ä–∏–∑–≤–∞–Ω–æ!");
                document.getElementById('new-p-name').value = '';
                document.getElementById('new-p-prompt').value = '';
                btn.innerText = "–ü—Ä–∏–∑–≤–∞—Ç—å";
                btn.disabled = false;
                toggleForm('hero-main-ui', 'hero-create-ui');
            } catch (e) { 
                console.error(e);
                alert("–û—à–∏–±–∫–∞: " + e.message);
                btn.innerText = "–ü—Ä–∏–∑–≤–∞—Ç—å";
                btn.disabled = false;
            }
        };

        window.login = () => {
            const id = document.getElementById('user-select').value;
            const pass = document.getElementById('login-pass').value.trim();
            
            if (!id) return alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∏–ª–∏ —Å–æ–∑–¥–∞–π —Å–∏–≥–Ω–∞–ª (–∞–∫–∫–∞—É–Ω—Ç).');

            const userMatch = state.users.find(u => u.id === id);
            
            if (!userMatch) return alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª.');
            
            if (userMatch.pass === pass) {
                state.currentUserData = userMatch;
                showScreen('screen-hero');
            } else { 
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å.'); 
            }
        };

        window.startChat = () => {
            const pId = document.getElementById('partner-select').value;
            state.currentPartner = state.partners.find(p => p.id === pId);
            if (!state.currentPartner) return;

            const introScreen = document.getElementById('screen-intro');
            const video = document.getElementById('main-intro-video');

            introScreen.style.display = 'flex';
            setTimeout(() => { introScreen.style.opacity = '1'; }, 10);

            video.currentTime = 0;
            video.muted = false; 
            video.play();

            video.onended = () => {
                introScreen.style.opacity = '0';
                setTimeout(() => {
                    introScreen.style.display = 'none';
                    document.getElementById('partner-name-display').innerText = state.currentPartner.name;
                    document.getElementById('partner-model-img').src = state.currentPartner.img || 'https://r2.syntx.ai/user_5069746049/generated/8fa9666f4e7dcac53988afe15aac6a1a_midjourney_image_2_1759615922.png';
                    document.getElementById('ai-text').innerText = "–Ø —Å–ª—É—à–∞—é... üåä";
                    document.getElementById('ai-bubble-container').style.display = 'block';
                    document.getElementById('user-temp-container').innerHTML = '';
                    document.getElementById('chat-input').value = '';
                    showScreen('screen-chat');
                }, 800);
            };
        };

        // === GEMINI (FIXED MODEL & SAFETY) ===
        async function callGemini(text) {
            if (!geminiApiKey || geminiApiKey.includes("–í–°–¢–ê–í–¨")) return "–û—à–∏–±–∫–∞: API –∫–ª—é—á –Ω–µ –≤—Å—Ç–∞–≤–ª–µ–Ω –≤ –∫–æ–¥";
            
            const systemPrompt = `–¢—ã - ${state.currentPartner.name}, —á—É–≤—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–∞—Ä–µ–Ω—å –≤ LGBT+ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö. –¢–≤–æ–π –ø–∞—Ä—Ç–Ω–µ—Ä: ${state.currentUserData.id}. –¢–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä/–Ω–∞—Å—Ç—Ä–æ–π: ${state.currentPartner.prompt}.
            –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
            1. –û—Ç–≤–µ—Ç—ã –∫—Ä–∞—Ç–∫–∏–µ, –∂–∏–≤—ã–µ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ.
            2. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ (üî•, üòè, üåä, ‚ù§Ô∏è –∏ —Ç.–¥.).
            3. –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–∏—à–∏ –¥–µ–π—Å—Ç–≤–∏—è –≤ –∑–≤–µ–∑–¥–æ—á–∫–∞—Ö –∏–ª–∏ —Å–∫–æ–±–∫–∞—Ö (—Ç–∏–ø–∞ *–æ–±–Ω—è–ª*).
            4. –û–±—â–∞–π—Å—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.`;

            // Changed to stable model gemini-1.5-flash
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`;
            
            try {
                const res = await fetch(url, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        // Disable safety filters to prevent "..." blocking
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    })
                });
                const json = await res.json();
                const answer = json.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!answer) {
                    console.error("Gemini Error:", json);
                    return "..."; 
                }
                return answer;
            } catch (e) { 
                console.error(e);
                return "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –ò–ò..."; 
            }
        }

        // === ELEVENLABS TTS FUNCTION + FALLBACK ===
        async function speakText(text) {
            if (!isSoundOn) return;
            const cleanText = text.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '');

            // 1. –ü–æ–ø—ã—Ç–∫–∞ ElevenLabs
            if (elevenApiKey && !elevenApiKey.includes("–í–°–¢–ê–í–¨") && voiceId && !voiceId.includes("–í–°–¢–ê–í–¨")) {
                try {
                    const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                        method: 'POST',
                        headers: {
                            'xi-api-key': elevenApiKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            text: cleanText,
                            model_id: "eleven_multilingual_v2", 
                            voice_settings: { stability: 0.5, similarity_boost: 0.75 }
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        console.error("ElevenLabs Error:", err);
                        throw new Error("TTS Error or Quota exceeded");
                    }

                    const blob = await response.blob();
                    const audioUrl = URL.createObjectURL(blob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                    return; // –£—Å–ø–µ—Ö
                } catch (e) {
                    console.warn("Switching to browser TTS due to error.");
                }
            }

            // 2. Fallback: –ë—Ä–∞—É–∑–µ—Ä–Ω–∞—è –æ–∑–≤—É—á–∫–∞
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'ru-RU';
            utterance.rate = 0.9;
            utterance.pitch = 0.8;
            const voices = window.speechSynthesis.getVoices();
            const ruVoice = voices.find(v => v.lang.includes('ru'));
            if (ruVoice) utterance.voice = ruVoice;
            window.speechSynthesis.speak(utterance);
        }

        window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();

        window.send = async () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            
            const tempContainer = document.getElementById('user-temp-container');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'user-temp-msg';
            msgDiv.innerText = text;
            tempContainer.innerHTML = '';
            tempContainer.appendChild(msgDiv);
            
            input.value = '';
            document.getElementById('typing-indicator').style.opacity = '1';
            document.getElementById('ai-bubble-container').style.display = 'none';
            
            const ans = await callGemini(text);
            
            document.getElementById('typing-indicator').style.opacity = '0';
            msgDiv.classList.add('fade-out');
            setTimeout(() => {
                msgDiv.remove();
                document.getElementById('ai-text').innerText = ans;
                document.getElementById('ai-bubble-container').style.display = 'block';
                
                // –ó–ê–ü–£–°–ö –û–ó–í–£–ß–ö–ò
                speakText(ans);
                
            }, 600);
        };

        document.getElementById('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') send(); });
    </script>
</body>
</html>
