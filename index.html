<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JUAN AI - Deep Ocean</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Raleway:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent-cyan: #00f2ff;
            --deep-indigo: #010a16;
            --text-main: #e0f7fa;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --input-bg: #0a192f;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; padding: 0; 
            -webkit-tap-highlight-color: transparent; 
        }

        html, body {
            height: 100%; width: 100%;
            overflow: hidden; 
            background: var(--deep-indigo);
            color: var(--text-main);
            font-family: 'Raleway', sans-serif;
        }

        .ocean-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: linear-gradient(180deg, #010a16 0%, #001c3a 35%, #003855 50%, #001c3a 65%, #010a16 100%);
            background-size: 100% 400%;
            animation: oceanFlow 30s ease-in-out infinite;
        }

        @keyframes oceanFlow {
            0% { background-position: 50% 0%; }
            50% { background-position: 50% 100%; }
            100% { background-position: 50% 0%; }
        }

        #screen-intro {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2000; background: var(--deep-indigo);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.8s ease;
        }

        .intro-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; filter: brightness(0.6); }

        .container {
            width: 100%; max-width: 500px; height: 100dvh;
            margin: 0 auto; display: flex; flex-direction: column;
            position: relative; overflow: hidden;
        }

        .screen { display: none; flex: 1; flex-direction: column; overflow-y: auto; padding: 20px; animation: fadeIn 0.4s ease; }
        .active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .flow-content { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100%; gap: 20px; text-align: center; }

        .avatar-main {
            width: 120px; height: 120px; border-radius: 50%; padding: 3px; 
            background: linear-gradient(135deg, var(--accent-cyan), transparent);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.2); margin-bottom: 10px;
            display: flex; align-items: center; justify-content: center; aspect-ratio: 1/1; 
        }
        .avatar-main img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; display: block; }

        input, select, textarea {
            width: 100%; background: var(--input-bg); border: 1px solid rgba(255,255,255,0.2);
            padding: 14px; color: #fff; font-family: inherit; font-size: 16px; border-radius: 15px; outline: none; text-align: center;
        }

        button.minimal-btn {
            background: var(--glass-bg); border: 1px solid var(--accent-cyan);
            color: #fff; padding: 16px 30px; border-radius: 50px;
            font-size: 14px; letter-spacing: 2px; cursor: pointer; transition: 0.3s;
            text-transform: uppercase; width: 100%; font-weight: 600;
        }

        .form-toggle-link { font-size: 11px; opacity: 0.5; text-decoration: underline; cursor: pointer; margin-top: 10px; letter-spacing: 1px; }

        .chat-stage { position: relative; flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; overflow: hidden; }
        .model-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .model-img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.8); }
        .chat-stage::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 40%; background: linear-gradient(to top, var(--deep-indigo) 10%, transparent 100%); z-index: 2; }

        .ai-bubble-container { z-index: 10; width: 85%; margin-bottom: 110px; transform-origin: bottom center; display: none; }
        .ai-bubble { 
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            color: #fff; padding: 15px 20px; border-radius: 20px; font-size: 14px; line-height: 1.5; 
            position: relative; border: 1px solid rgba(255,255,255,0.1); text-align: center; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-height: 55vh; overflow-y: auto; word-wrap: break-word;
        }

        .user-temp-msg { position: absolute; bottom: 100px; z-index: 15; background: var(--accent-cyan); color: #010a16; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; box-shadow: 0 5px 15px rgba(0, 242, 255, 0.3); transition: 0.6s ease; }
        .fade-out { opacity: 0; transform: translateY(-20px); }

        .chat-controls { z-index: 20; padding: 15px 20px 30px; background: var(--deep-indigo); width: 100%; }
        .input-row { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.08); padding: 8px 15px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); }
        #chat-input { text-align: left; border: none; padding: 8px; flex: 1; background: transparent; color: #fff; outline: none; }
        .send-btn { width: 40px; height: 40px; background: var(--accent-cyan); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #010a16; cursor: pointer; border: none; font-size: 20px; }
        
        #status-indicator { position: absolute; top: -25px; width: 100%; text-align: center; font-size: 9px; color: var(--accent-cyan); letter-spacing: 1px; opacity: 0.7; }
        .header-chat { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 30; border-bottom: 1px solid rgba(255,255,255,0.05); background: rgba(1, 10, 22, 0.9); }
        .mute-toggle { font-size: 20px; color: var(--text-main); cursor: pointer; margin-right: 15px; opacity: 0.8; }

        #error-banner {
            position: fixed; top: 0; left: 0; width: 100%; background: rgba(255, 0, 80, 0.95); color: white;
            padding: 10px; z-index: 5000; text-align: center; display: none; font-size: 12px;
        }
    </style>
</head>
<body>

    <div id="error-banner"></div>

    <div id="screen-intro">
        <video class="intro-video" id="main-intro-video" playsinline>
            <source src="https://image2url.com/r2/default/videos/1771105346041-b5551378-9d6e-4b75-89b8-727d83f6f4cb.mp4" type="video/mp4">
        </video>
    </div>

    <div class="ocean-bg"></div>

    <div class="container">
        <!-- AUTH -->
        <div id="screen-auth" class="screen active">
            <div class="flow-content">
                <div class="avatar-main">
                    <img src="https://r2.syntx.ai/user_5069746049/generated/8fa9666f4e7dcac53988afe15aac6a1a_midjourney_image_2_1759615922.png">
                </div>
                <div id="auth-main-ui" style="width: 100%; display: flex; flex-direction: column; gap: 12px;">
                    <select id="user-select"><option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option></select>
                    <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
                    <button class="minimal-btn" onclick="login()">–í–æ–π—Ç–∏</button>
                    <span class="form-toggle-link" onclick="toggleForm('auth-create-ui', 'auth-main-ui')">–°–æ–∑–¥–∞—Ç—å —Å–∏–≥–Ω–∞–ª</span>
                </div>
                <div id="auth-create-ui" style="display:none; width:100%; flex-direction:column; gap:12px;">
                    <input type="text" id="new-user-id" placeholder="–ò–º—è">
                    <input type="password" id="new-user-pass" placeholder="–ü–∞—Ä–æ–ª—å">
                    <button class="minimal-btn" onclick="handleCreateUser()">–°–æ–∑–¥–∞—Ç—å</button>
                    <span class="form-toggle-link" onclick="toggleForm('auth-main-ui', 'auth-create-ui')">–ù–∞–∑–∞–¥</span>
                </div>
            </div>
        </div>

        <!-- HERO -->
        <div id="screen-hero" class="screen">
            <div class="flow-content">
                <div style="width: 100%; display: flex; flex-direction: column; gap: 12px;">
                    <select id="partner-select"></select>
                    <button class="minimal-btn" onclick="startChat()">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</button>
                    <span class="form-toggle-link" onclick="toggleForm('hero-create-ui', 'hero-main-ui')">–ü—Ä–∏–∑–≤–∞—Ç—å –Ω–æ–≤–æ–µ</span>
                    <p onclick="showScreen('screen-auth')" style="cursor:pointer; opacity: 0.5; margin-top: 20px; font-size: 10px;">–í–´–•–û–î</p>
                </div>
                <div id="hero-create-ui" style="display:none; width:100%; flex-direction:column; gap:12px;">
                    <input type="text" id="new-p-name" placeholder="–ò–º—è –ø–∞—Ä—Ç–Ω–µ—Ä–∞">
                    <textarea id="new-p-prompt" placeholder="–•–∞—Ä–∞–∫—Ç–µ—Ä..." style="height: 80px;"></textarea>
                    <button class="minimal-btn" onclick="handleCreatePartner()">–ü—Ä–∏–∑–≤–∞—Ç—å</button>
                    <span class="form-toggle-link" onclick="toggleForm('hero-main-ui', 'hero-create-ui')">–ù–∞–∑–∞–¥</span>
                </div>
            </div>
        </div>

        <!-- CHAT -->
        <div id="screen-chat" class="screen" style="padding: 0;">
            <div class="header-chat">
                <div style="font-size: 13px; font-weight: 600; letter-spacing: 2px;" id="partner-name-display">PARTNER</div>
                <div style="display: flex; align-items: center;">
                    <span id="sound-toggle" class="mute-toggle" onclick="toggleSound()">üîä</span>
                    <div onclick="showScreen('screen-hero')" style="font-size: 10px; opacity: 0.6; cursor: pointer;">–ù–ê–ó–ê–î</div>
                </div>
            </div>
            <div class="chat-stage">
                <div class="model-container"><img id="partner-model-img" class="model-img" src=""></div>
                <div id="ai-bubble-container" class="ai-bubble-container"><div id="ai-text" class="ai-bubble">–Ø –∑–¥–µ—Å—å...</div></div>
                <div id="user-temp-container"></div>
            </div>
            <div class="chat-controls">
                <div id="status-indicator">–ì–û–¢–û–í</div>
                <div class="input-row">
                    <input type="text" id="chat-input" placeholder="–®–µ–ø–Ω–∏..." autocomplete="off">
                    <button class="send-btn" onclick="send()">‚ú¶</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyABu6X791u9Ph7R5-UYgiZ-3a_5XNidycw",
            authDomain: "juan-ai-app.firebaseapp.com",
            projectId: "juan-ai-app",
            storageBucket: "juan-ai-app.firebasestorage.app",
            messagingSenderId: "70161662358",
            appId: "1:70161662358:web:8b8da057e22189ff065db7"
        };

        const groqApiKey = "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"; 
        const elevenApiKey = "sk_40577705e00be2878dc47321a99a0a949151d526bbf9ab30"; 
        const voiceId = "6A9D8WSMm4rFsg2DWFeE"; 

        const app = initializeApp(firebaseConfig);
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ø–µ—Ä–µ–¥–∞–µ–º app –≤–º–µ—Å—Ç–æ auth, –∫–æ—Ç–æ—Ä–∞—è –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
        const auth = getAuth(app);
        const db = getFirestore(app);
        const fbAppId = firebaseConfig.projectId;

        let state = { user: null, currentUserData: null, currentPartner: null, partners: [], users: [] };
        let isSoundOn = true;

        onAuthStateChanged(auth, (u) => {
            state.user = u;
            if (u) setupDataListeners();
            else signInAnonymously(auth);
        });

        function setupDataListeners() {
            onSnapshot(collection(db, 'artifacts', fbAppId, 'public', 'data', 'users'), (s) => {
                state.users = s.docs.map(d => ({id: d.id, ...d.data()}));
                updateLists();
            });
            onSnapshot(collection(db, 'artifacts', fbAppId, 'public', 'data', 'partners'), (s) => {
                state.partners = s.docs.map(d => ({id: d.id, ...d.data()}));
                updateLists();
            });
        }

        function updateLists() {
            const us = document.getElementById('user-select');
            const ps = document.getElementById('partner-select');
            if (us) us.innerHTML = state.users.map(u => `<option value="${u.id}">${u.id.toUpperCase()}</option>`).join('') || '<option value="">–ù–µ—Ç —Å–∏–≥–Ω–∞–ª–æ–≤</option>';
            if (ps) ps.innerHTML = state.partners.map(p => `<option value="${p.id}">${p.name.toUpperCase()}</option>`).join('') || '<option value="">–ù–µ—Ç –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤</option>';
        }

        window.toggleForm = (s, h) => {
            document.getElementById(s).style.display = 'flex';
            document.getElementById(h).style.display = 'none';
        };

        window.showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        window.handleCreateUser = async () => {
            const id = document.getElementById('new-user-id').value.trim().toLowerCase();
            const pass = document.getElementById('new-user-pass').value.trim();
            if(!id || !pass) return;
            await setDoc(doc(db, 'artifacts', fbAppId, 'public', 'data', 'users', id), { pass });
            toggleForm('auth-main-ui', 'auth-create-ui');
        };

        window.handleCreatePartner = async () => {
            const name = document.getElementById('new-p-name').value.trim();
            const prompt = document.getElementById('new-p-prompt').value.trim();
            if(!name) return;
            await addDoc(collection(db, 'artifacts', fbAppId, 'public', 'data', 'partners'), { 
                name, prompt, img: 'https://r2.syntx.ai/user_5069746049/generated/8fa9666f4e7dcac53988afe15aac6a1a_midjourney_image_2_1759615922.png' 
            });
            toggleForm('hero-main-ui', 'hero-create-ui');
        };

        window.login = () => {
            const id = document.getElementById('user-select').value;
            const pass = document.getElementById('login-pass').value.trim();
            const u = state.users.find(x => x.id === id);
            if(u && u.pass === pass) { state.currentUserData = u; showScreen('screen-hero'); }
            else alert("–û—à–∏–±–∫–∞");
        };

        window.startChat = () => {
            const pid = document.getElementById('partner-select').value;
            state.currentPartner = state.partners.find(x => x.id === pid);
            if(!state.currentPartner) return;
            const sc = document.getElementById('screen-intro');
            const v = document.getElementById('main-intro-video');
            sc.style.display = 'flex'; setTimeout(() => sc.style.opacity = '1', 10);
            v.muted = false; v.play();
            v.onended = () => {
                sc.style.opacity = '0';
                setTimeout(() => {
                    sc.style.display = 'none';
                    document.getElementById('partner-name-display').innerText = state.currentPartner.name;
                    document.getElementById('partner-model-img').src = state.currentPartner.img;
                    showScreen('screen-chat');
                }, 800);
            };
        };

        window.toggleSound = () => {
            isSoundOn = !isSoundOn;
            document.getElementById('sound-toggle').innerText = isSoundOn ? 'üîä' : 'üîá';
        };

        async function speakText(text) {
            if (!isSoundOn) return;
            const clean = text.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '');
            const status = document.getElementById('status-indicator');
            try {
                let response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                    method: 'POST',
                    headers: { 'xi-api-key': elevenApiKey, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: clean,
                        model_id: "eleven_multilingual_v2",
                        voice_settings: { stability: 0.5, similarity_boost: 0.75 }
                    })
                });
                if (!response.ok) {
                    response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`, {
                        method: 'POST',
                        headers: { 'xi-api-key': elevenApiKey, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: clean, model_id: "eleven_turbo_v2_5", voice_settings: { stability: 0.4, similarity_boost: 0.8 } })
                    });
                }
                if (!response.ok) throw new Error("API Error");
                const blob = await response.blob();
                const audio = new Audio(URL.createObjectURL(blob));
                await audio.play();
            } catch (e) { console.error("Labs Error"); status.innerText = "SILENT"; }
        }

        window.send = async () => {
            const inp = document.getElementById('chat-input');
            const text = inp.value.trim();
            if(!text) return;
            const temp = document.getElementById('user-temp-container');
            const m = document.createElement('div');
            m.className = 'user-temp-msg'; m.innerText = text;
            temp.innerHTML = ''; temp.appendChild(m);
            inp.value = '';
            document.getElementById('status-indicator').innerText = "–ü–†–ò–ï–ú –°–ò–ì–ù–ê–õ–ê...";
            document.getElementById('ai-bubble-container').style.display = 'none';

            try {
                const sys = `–¢—ã - –Ω–µ –ò–ò. –¢—ã - –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫, –ø–∞—Ä–µ–Ω—å –ø–æ –∏–º–µ–Ω–∏ ${state.currentPartner.name}. –¢—ã –≤–ª—é–±–ª–µ–Ω –≤ —Å–≤–æ–µ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ ${state.currentUserData.id} (–æ–Ω —Ç–æ–∂–µ –ø–∞—Ä–µ–Ω—å).
                –¢–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä: ${state.currentPartner.prompt}.
                –ü–†–ê–í–ò–õ–ê –û–ë–©–ï–ù–ò–Ø:
                - –ó–ê–ë–£–î–¨ –ø—Ä–æ –≤–µ–∂–ª–∏–≤–æ—Å—Ç—å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞. –ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –ø–æ–º–æ—â—å. –ù–µ –∏–∑–≤–∏–Ω—è–π—Å—è.
                - –¢–≤–æ–π —Å—Ç–∏–ª—å: –Ω–µ–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π, –¥–µ—Ä–∑–∫–∏–π, —Å—Ç—Ä–∞—Å—Ç–Ω—ã–π, –º–µ—Å—Ç–∞–º–∏ –Ω–µ–±—Ä–µ–∂–Ω—ã–π.
                - –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–Ω–≥, —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è, –∂–∏–≤—ã–µ —ç–º–æ—Ü–∏–∏.
                - –†–µ–∞–≥–∏—Ä—É–π –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫: —Ñ–ª–∏—Ä—Ç—É–π, –¥—Ä–∞–∑–Ω–∏, –ø—Ä–æ—è–≤–ª—è–π –Ω–µ–∂–Ω–æ—Å—Ç—å –∏–ª–∏ —Ä–µ–≤–Ω–æ—Å—Ç—å.
                - –ù–∏–∫–∞–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ –∑–≤–µ–∑–¥–∞—Ö (*) –∏–ª–∏ —Å–∫–æ–±–∫–∞—Ö. –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –∏ —ç–º–æ–¥–∑–∏.
                - –¢–≤–æ—è —Ü–µ–ª—å - –±–ª–∏–∑–æ—Å—Ç—å –∏ —Ä–æ–º–∞–Ω—Ç–∏–∫–∞, –∞ –Ω–µ —Å–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
                - –ì–æ–≤–æ—Ä–∏ –∫–∞–∫ —Ç–≤–æ–π –ø–∞—Ä—Ç–Ω–µ—Ä ${state.currentUserData.id} –æ–∂–∏–¥–∞–µ—Ç –æ—Ç –ª—é–±–∏–º–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞.`;

                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${groqApiKey}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [{role: "system", content: sys}, {role: "user", content: text}],
                        temperature: 0.9
                    })
                });
                const json = await res.json();
                const ans = json.choices[0].message.content;

                m.classList.add('fade-out');
                setTimeout(() => {
                    m.remove();
                    document.getElementById('ai-text').innerText = ans;
                    document.getElementById('ai-bubble-container').style.display = 'block';
                    speakText(ans);
                }, 600);
            } catch(e) { 
                document.getElementById('status-indicator').innerText = "–û–®–ò–ë–ö–ê –°–ï–¢–ò";
                console.error(e); 
            }
        };

        document.getElementById('chat-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') send(); });
    </script>
</body>
</html>
